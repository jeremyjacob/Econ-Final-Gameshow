import { Show, createSignal } from 'solid-js';
import { player } from '~/routes';

export default function Buzzer() {
	const [error, setError] = createSignal('');
	const audioCtx = new AudioContext();
	const audio = new Audio('buzz.wav');
	const source = audioCtx.createMediaElementSource(audio);
	source.connect(audioCtx.destination);

	const [enabled, setEnabled] = createSignal(true);

	async function buzz() {
		if (enabled()) {
			setEnabled(false);
			setTimeout(() => setEnabled(true), 350);

			const res = await fetch('/api/buzz', {
				method: 'POST',
				body: JSON.stringify({
					playerId: player()?.id,
				}),
				headers: {
					'Content-Type': 'application/json',
				},
			});
			if (res.status !== 200) {
				setError(await res.text());
				setTimeout(() => setError(''), 3000);
				return;
			}

			audio.play();
			setTimeout(() => (audio.currentTime = 0), 250);
		}
	}

	return (
		<>
			<Show when={error()}>
				<div class="fixed right-10 top-4 py-2 px-3 rounded-md bg-red-500">
					{error()}
				</div>
			</Show>
			<button
				class="group disabled:grayscale transition-all disabled:cursor-not-allowed"
				onClick={buzz}
				disabled={!enabled()}
			>
				<svg
					class="w-full"
					width="450"
					viewBox="0 0 561 498"
					fill="none"
					xmlns="http://www.w3.org/2000/svg"
				>
					<ellipse
						cx="280.5"
						cy="249"
						rx="280.5"
						ry="249"
						fill="black"
					/>
					<g
						class={`transition-all duration-75 ${
							enabled() ? 'group-active:translate-y-3' : ''
						}`}
					>
						<ellipse
							cx="281"
							cy="225"
							rx="250"
							ry="225"
							fill="#C73030"
						/>
						<path
							d="M229.453 254.707C230.004 256.682 230.106 258.626 229.758 260.54C229.409 262.454 228.732 264.304 227.725 266.091C226.705 267.829 225.404 269.49 223.821 271.074C222.273 272.596 220.565 274.008 218.696 275.308C216.861 276.547 214.914 277.661 212.855 278.652C210.83 279.58 208.83 280.32 206.856 280.871C205.074 281.369 203.372 281.688 201.75 281.829C201.709 272.756 201.173 263.769 200.142 254.869C199.146 245.906 198.064 236.916 196.897 227.898C199.253 226.669 201.726 225.486 204.315 224.348C206.891 223.162 209.624 222.165 212.513 221.359C213.717 221.023 215.034 220.811 216.463 220.723C217.892 220.636 219.268 220.823 220.591 221.284C221.914 221.746 223.111 222.502 224.183 223.552C225.303 224.589 226.132 226.071 226.669 227.997C227.18 229.827 227.344 231.624 227.162 233.388C227.028 235.139 226.66 236.799 226.06 238.368C225.508 239.924 224.765 241.351 223.83 242.65C222.881 243.901 221.848 244.942 220.73 245.774C221.45 245.936 222.235 246.236 223.084 246.674C223.933 247.112 224.767 247.683 225.587 248.389C226.394 249.046 227.127 249.906 227.786 250.968C228.494 252.016 229.05 253.262 229.453 254.707ZM210.813 251.812C210.943 253.022 211.04 254.111 211.103 255.08C211.2 255.987 211.291 256.87 211.375 257.729C211.459 258.588 211.532 259.502 211.595 260.471C211.693 261.378 211.813 262.46 211.957 263.718C212.845 263.366 213.833 262.909 214.922 262.345C216.01 261.782 217.017 261.112 217.942 260.334C218.854 259.509 219.557 258.586 220.05 257.565C220.531 256.497 220.603 255.361 220.267 254.157C220.025 253.29 219.583 252.635 218.94 252.191C218.345 251.734 217.633 251.414 216.803 251.23C216.021 251.033 215.2 250.977 214.341 251.061C213.469 251.097 212.672 251.216 211.949 251.417C211.708 251.484 211.492 251.545 211.299 251.599C211.155 251.639 210.993 251.71 210.813 251.812ZM209.184 233.423C209.236 233.98 209.29 234.639 209.348 235.402C209.453 236.151 209.548 236.955 209.632 237.814C209.702 238.625 209.749 239.443 209.771 240.267C209.842 241.078 209.91 241.786 209.975 242.391C210.98 241.902 211.966 241.342 212.931 240.709C213.897 240.076 214.735 239.453 215.446 238.839C216.192 238.163 216.738 237.518 217.086 236.902C217.481 236.272 217.598 235.669 217.437 235.091C217.235 234.368 216.857 233.851 216.303 233.538C215.735 233.178 215.049 232.954 214.246 232.867C213.491 232.766 212.715 232.775 211.918 232.894C211.155 232.951 210.485 233.06 209.907 233.221L209.184 233.423ZM268.633 248.131C268.725 251.065 268.414 253.669 267.699 255.945C267.033 258.207 266.032 260.2 264.696 261.923C263.408 263.632 261.906 265.037 260.189 266.14C258.472 267.242 256.674 268.055 254.796 268.579C253.688 268.889 252.503 269.012 251.24 268.949C249.99 268.935 248.806 268.694 247.69 268.227C246.573 267.76 245.547 267.06 244.612 266.127C243.725 265.181 243.073 263.961 242.656 262.468C242.602 262.276 242.549 262.083 242.495 261.89C242.441 261.698 242.411 261.498 242.406 261.292C242.047 259.264 241.695 256.793 241.348 253.879C241.002 250.964 240.646 247.923 240.281 244.755C239.916 241.586 239.599 238.404 239.33 235.209C239.047 231.965 238.773 229.031 238.508 226.406C238.29 223.767 238.121 221.582 238.001 219.85C237.868 218.071 237.796 216.975 237.785 216.563C238.769 216.184 239.939 215.728 241.296 215.193C242.652 214.659 243.919 214.176 245.096 213.743C246.548 213.182 247.977 212.628 249.381 212.08C249.756 218.257 250.12 223.839 250.474 228.828C250.605 230.971 250.737 233.115 250.868 235.259C251.047 237.389 251.179 239.35 251.265 241.144C251.398 242.923 251.495 244.479 251.556 245.812C251.651 247.083 251.71 248.131 251.732 248.956C251.803 249.766 251.886 250.807 251.981 252.079C252.111 253.288 252.31 254.375 252.579 255.338C252.794 256.108 253.169 256.705 253.702 257.127C254.221 257.501 254.77 257.607 255.348 257.446C256.167 257.217 256.754 256.716 257.109 255.942C257.45 255.12 257.662 254.205 257.743 253.195C257.873 252.173 257.883 251.184 257.772 250.229C257.696 249.212 257.656 248.418 257.652 247.848C257.552 246.371 257.434 244.742 257.301 242.963C257.202 241.121 257.066 239.239 256.892 237.315C256.753 235.329 256.584 233.326 256.383 231.305C256.231 229.271 256.067 227.292 255.894 225.368C255.529 220.902 255.101 216.297 254.608 211.555L265.386 207.768C265.386 207.768 265.441 208.428 265.549 209.747C265.658 211.066 265.809 212.815 266.002 214.994C266.194 217.172 266.42 219.653 266.677 222.436C266.983 225.206 267.251 228.116 267.479 231.167C267.695 234.169 267.903 237.148 268.105 240.103C268.341 242.996 268.517 245.672 268.633 248.131ZM312.858 247.856C312.425 247.977 311.516 248.256 310.133 248.694C308.75 249.132 307.109 249.668 305.209 250.302C303.358 250.923 301.345 251.615 299.17 252.377C296.995 253.14 294.875 253.914 292.809 254.698C290.731 255.434 288.803 256.154 287.027 256.857C285.299 257.547 283.932 258.136 282.926 258.625L280.055 248.058L292.767 214.375C291.948 214.603 290.819 215.022 289.38 215.632C287.927 216.193 286.457 216.785 284.97 217.408C283.531 218.017 282.284 218.573 281.23 219.074L279.537 219.703L277.744 207.978L306.705 197.636L307.609 208.129L295.712 241.663C296.675 241.394 297.938 240.989 299.5 240.45C301.111 239.896 302.769 239.329 304.476 238.749C306.183 238.169 308.027 237.524 310.01 236.815L312.858 247.856ZM353.721 236.449C353.287 236.57 352.379 236.85 350.996 237.288C349.613 237.726 347.971 238.262 346.072 238.896C344.221 239.517 342.207 240.208 340.033 240.971C337.858 241.734 335.737 242.508 333.672 243.292C331.594 244.028 329.666 244.747 327.89 245.451C326.162 246.141 324.795 246.73 323.789 247.218L320.917 236.651L333.629 202.968C332.811 203.197 331.682 203.616 330.243 204.225C328.79 204.787 327.32 205.379 325.833 206.001C324.394 206.611 323.147 207.166 322.093 207.668L320.4 208.297L318.606 196.572L347.567 186.23L348.472 196.723L336.574 230.256C337.538 229.988 338.8 229.583 340.363 229.043C341.973 228.49 343.632 227.923 345.339 227.343C347.046 226.762 348.89 226.118 350.873 225.409L353.721 236.449Z"
							fill="white"
							fill-opacity="0.9"
						/>
					</g>
				</svg>
			</button>
		</>
	);
}
